<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –†–ñ–î–ö –£—Å—Å—É—Ä–∏–π—Å–∫</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=be0c8369-7476-47a3-a315-59ab429fadcb&lang=ru_RU"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* –ù–∏–∂–Ω—è—è —à—Ç–æ—Ä–∫–∞ */
        .building-sheet {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transition: bottom 0.4s ease;
            z-index: 999;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
        }

        .building-sheet.active {
            bottom: 0;
        }

        .sheet-handle {
            width: 50px;
            height: 4px;
            background: #7f8c8d;
            border-radius: 2px;
            margin: 0 auto 20px auto;
        }

        /* –ö–Ω–æ–ø–∫–∏ –∑–¥–∞–Ω–∏–π */
        .buildings-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 998;
        }

        .building-btn {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.98);
            z-index: 1003;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-content {
            background: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px auto;
        }

        .admin-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .pin-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: #34495e;
            color: white;
        }

        .file-upload {
            border: 2px dashed #7f8c8d;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .buildings-bar {
                bottom: 10px;
                flex-wrap: nowrap;
                overflow-x: auto;
                max-width: 90%;
                padding: 0 10px;
            }
            
            .building-btn {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .admin-content {
                margin: 10px auto;
                padding: 15px;
            }
        }

        .building-image {
            width: 100%;
            height: 200px;
            background: #34495e;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bdc3c7;
            border: 2px dashed #7f8c8d;
            position: relative;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: #34495e;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .tab.active {
            background: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .group-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .group-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .floor-item {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .coords-display {
            background: #34495e;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–æ–º</h2>
            
            <div class="admin-section">
                <h3>üè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è–º–∏</h3>
                <select id="buildingSelect" class="pin-input" onchange="loadBuildingData()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</option>
                </select>
                
                <input type="text" id="buildingName" class="pin-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è">
                
                <div class="coords-display" id="coordsDisplay">
                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                </div>
                <button class="btn" onclick="startPlacemarkMode()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</button>
                
                <button class="btn" onclick="saveBuilding()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
                <button class="btn btn-success" onclick="addNewBuilding()">‚ûï –ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ</button>
                <button class="btn btn-danger" onclick="deleteBuilding()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
            </div>

            <div class="admin-section" id="buildingDetails" style="display: none;">
                <h3>üìã –î–µ—Ç–∞–ª–∏ –∑–¥–∞–Ω–∏—è: <span id="currentBuildingName">‚Äî</span></h3>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('floors')">–≠—Ç–∞–∂–∏</button>
                    <button class="tab" onclick="switchTab('groups')">–ì—Ä—É–ø–ø—ã</button>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –≠—Ç–∞–∂–∏ -->
                <div class="tab-content active" id="floorsTab">
                    <div id="floorsList">
                        <!-- –°–ø–∏—Å–æ–∫ —ç—Ç–∞–∂–µ–π -->
                    </div>
                    <button class="btn btn-success" onclick="addFloor()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–∂</button>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –ì—Ä—É–ø–ø—ã -->
                <div class="tab-content" id="groupsTab">
                    <input type="text" id="newGroupName" class="pin-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                    <button class="btn btn-success" onclick="addGroup()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                    
                    <div id="groupsList">
                        <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø -->
                    </div>
                </div>
            </div>

            <button class="btn btn-danger" onclick="hideAdminPanel()">‚ùå –ó–∞–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É</button>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∑–¥–∞–Ω–∏–π -->
    <div class="buildings-bar" id="buildingsBar">
        <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>

    <!-- –®—Ç–æ—Ä–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–¥–∞–Ω–∏–∏ -->
    <div class="building-sheet" id="buildingSheet">
        <div class="sheet-handle"></div>
        <h3 id="sheetBuildingName">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è</h3>
        
        <div class="tabs">
            <button class="tab active" onclick="switchUserTab('floors')">üè¢ –≠—Ç–∞–∂–∏</button>
            <button class="tab" onclick="switchUserTab('schedule')">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –≠—Ç–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="tab-content active" id="userFloorsTab">
            <div id="userFloorsList">
                <!-- –≠—Ç–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="tab-content" id="userScheduleTab">
            <div id="userGroupsList">
                <!-- –ì—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            </div>
        </div>
        
        <button class="btn" onclick="closeBuildingSheet()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const ADMIN_SECRET = "secret";
        let map;
        let buildings = [];
        let currentBuildingId = null;
        let isAdminMode = false;
        let placemarkMode = false;
        let tempPlacemark = null;

        const defaultBuildings = [
            {
                id: 1,
                name: '–ì–ª–∞–≤–Ω—ã–π –∫–æ—Ä–ø—É—Å',
                coords: [43.790882, 131.944252],
                floors: [],
                groups: []
            }
        ];

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminParam = urlParams.get('admin');
            
            if (adminParam === ADMIN_SECRET) {
                isAdminMode = true;
                showAdminPanel();
            }
        }

        function initMap() {
            map = new ymaps.Map('map', {
                center: [43.790882, 131.944252],
                zoom: 17,
                controls: ['zoomControl', 'fullscreenControl']
            });

            loadBuildings();
            checkAdminAccess();
        }

        function loadBuildings() {
            const saved = localStorage.getItem('rzhdk_buildings');
            buildings = saved ? JSON.parse(saved) : defaultBuildings;
            
            renderBuildings();
            renderBuildingButtons();
            updateBuildingSelect();
        }

        function saveBuildings() {
            localStorage.setItem('rzhdk_buildings', JSON.stringify(buildings));
        }

        function renderBuildings() {
            map.geoObjects.removeAll();
            
            // –í —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∫–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫–∏
            if (isAdminMode) return;
            
            buildings.forEach(building => {
                const placemark = new ymaps.Placemark(building.coords, {
                    balloonContent: `<strong>${building.name}</strong>`
                }, {
                    preset: 'islands#blueIcon'
                });
                
                placemark.events.add('click', () => {
                    showBuildingSheet(building);
                });
                
                map.geoObjects.add(placemark);
            });
        }

        function renderBuildingButtons() {
            const bar = document.getElementById('buildingsBar');
            bar.innerHTML = '';
            
            buildings.forEach(building => {
                const btn = document.createElement('button');
                btn.className = 'building-btn';
                btn.textContent = building.name;
                btn.onclick = () => {
                    map.setCenter(building.coords, 17);
                    showBuildingSheet(building);
                };
                bar.appendChild(btn);
            });
        }

        function updateBuildingSelect() {
            const select = document.getElementById('buildingSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</option>';
            
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                select.appendChild(option);
            });
        }

        function loadBuildingData() {
            const buildingId = parseInt(document.getElementById('buildingSelect').value);
            currentBuildingId = buildingId;
            
            if (!buildingId) {
                clearBuildingForm();
                return;
            }
            
            const building = buildings.find(b => b.id === buildingId);
            if (building) {
                document.getElementById('buildingName').value = building.name;
                document.getElementById('currentBuildingName').textContent = building.name;
                document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${building.coords[0]}, ${building.coords[1]}`;
                document.getElementById('buildingDetails').style.display = 'block';
                
                renderFloors(building);
                renderGroups(building);
            }
        }

        function clearBuildingForm() {
            document.getElementById('buildingName').value = '';
            document.getElementById('currentBuildingName').textContent = '‚Äî';
            document.getElementById('coordsDisplay').textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã';
            document.getElementById('buildingDetails').style.display = 'none';
            currentBuildingId = null;
        }

        function startPlacemarkMode() {
            if (!currentBuildingId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–¥–∞–Ω–∏–µ');
                return;
            }
            
            placemarkMode = true;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            if (tempPlacemark) {
                map.geoObjects.remove(tempPlacemark);
            }
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            tempPlacemark = new ymaps.Placemark(map.getCenter(), {}, {
                preset: 'islands#redIcon',
                draggable: true
            });
            
            map.geoObjects.add(tempPlacemark);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
            tempPlacemark.events.add('dragend', function() {
                const coords = tempPlacemark.geometry.getCoordinates();
                document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            });
            
            alert('üìç –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –º–µ—Ç–∫—É –Ω–∞ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–¥–∞–Ω–∏–µ');
        }

        function addNewBuilding() {
            const newId = buildings.length > 0 ? Math.max(...buildings.map(b => b.id)) + 1 : 1;
            currentBuildingId = newId;
            
            clearBuildingForm();
            document.getElementById('buildingName').value = '–ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ';
            document.getElementById('currentBuildingName').textContent = '–ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ';
            document.getElementById('buildingDetails').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('buildingSelect').value = newId;
            }, 100);
        }

        function saveBuilding() {
            if (!currentBuildingId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–¥–∞–Ω–∏–µ');
                return;
            }
            
            let building = buildings.find(b => b.id === currentBuildingId);
            let coords;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ
            if (tempPlacemark) {
                coords = tempPlacemark.geometry.getCoordinates();
                map.geoObjects.remove(tempPlacemark);
                tempPlacemark = null;
            } else if (building) {
                coords = building.coords;
            } else {
                coords = map.getCenter();
            }
            
            if (!building) {
                building = {
                    id: currentBuildingId,
                    name: document.getElementById('buildingName').value,
                    coords: coords,
                    floors: [],
                    groups: []
                };
                buildings.push(building);
            } else {
                building.name = document.getElementById('buildingName').value;
                building.coords = coords;
            }
            
            document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            
            saveBuildings();
            renderBuildings();
            renderBuildingButtons();
            updateBuildingSelect();
            
            alert('‚úÖ –ó–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            placemarkMode = false;
        }

        function deleteBuilding() {
            if (!currentBuildingId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ "${document.getElementById('buildingName').value}"?`)) {
                return;
            }
            
            buildings = buildings.filter(b => b.id !== currentBuildingId);
            saveBuildings();
            renderBuildings();
            renderBuildingButtons();
            updateBuildingSelect();
            clearBuildingForm();
            
            alert('‚úÖ –ó–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
        }

        function addFloor() {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            const floorNumber = building.floors.length + 1;
            
            building.floors.push({
                number: floorNumber,
                name: `–≠—Ç–∞–∂ ${floorNumber}`,
                plan: null
            });
            
            saveBuildings();
            renderFloors(building);
        }

        function renderFloors(building) {
            const floorsList = document.getElementById('floorsList');
            floorsList.innerHTML = '';
            
            building.floors.forEach((floor, index) => {
                const floorItem = document.createElement('div');
                floorItem.className = 'floor-item';
                floorItem.innerHTML = `
                    <strong>${floor.name}</strong>
                    <div style="margin-top: 10px;">
                        <input type="text" value="${floor.name}" onchange="updateFloorName(${index}, this.value)" class="pin-input" style="font-size: 12px; padding: 8px;">
                        <div class="file-upload" onclick="document.getElementById('floorPlan${index}').click()">
                            ${floor.plan ? '‚úÖ –ü–ª–∞–Ω –∑–∞–≥—Ä—É–∂–µ–Ω' : 'üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞–Ω —ç—Ç–∞–∂–∞'}
                        </div>
                        <input type="file" id="floorPlan${index}" style="display: none;" accept="image/*" onchange="uploadFloorPlan(${index}, this.files[0])">
                        <button class="btn" style="background: #e74c3c; padding: 8px; margin-top: 5px;" onclick="deleteFloor(${index})">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                floorsList.appendChild(floorItem);
            });
        }

        function updateFloorName(floorIndex, newName) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.floors[floorIndex].name = newName;
            saveBuildings();
        }

        function uploadFloorPlan(floorIndex, file) {
            if (!currentBuildingId) return;
            
            if (file && file.size > 5 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5MB');
                return;
            }
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const building = buildings.find(b => b.id === currentBuildingId);
                    building.floors[floorIndex].plan = e.target.result;
                    saveBuildings();
                    renderFloors(building);
                    alert('‚úÖ –ü–ª–∞–Ω —ç—Ç–∞–∂–∞ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteFloor(floorIndex) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.floors.splice(floorIndex, 1);
            saveBuildings();
            renderFloors(building);
        }

        function addGroup() {
            if (!currentBuildingId) return;
            
            const groupName = document.getElementById('newGroupName').value.trim();
            if (!groupName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            const building = buildings.find(b => b.id === currentBuildingId);
            
            building.groups.push({
                name: groupName,
                schedule: null
            });
            
            document.getElementById('newGroupName').value = '';
            saveBuildings();
            renderGroups(building);
        }

        function renderGroups(building) {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';
            
            building.groups.forEach((group, index) => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <div class="group-header">
                        <strong>${group.name}</strong>
                        <button class="btn" style="background: #e74c3c; padding: 5px 10px;" onclick="deleteGroup(${index})">‚ùå</button>
                    </div>
                    <div class="file-upload" onclick="document.getElementById('groupSchedule${index}').click()">
                        ${group.schedule ? '‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ' : 'üìÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'}
                    </div>
                    <input type="file" id="groupSchedule${index}" style="display: none;" accept="image/*" onchange="uploadGroupSchedule(${index}, this.files[0])">
                `;
                groupsList.appendChild(groupItem);
            });
        }

        function uploadGroupSchedule(groupIndex, file) {
            if (!currentBuildingId) return;
            
            if (file && file.size > 5 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5MB');
                return;
            }
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const building = buildings.find(b => b.id === currentBuildingId);
                    building.groups[groupIndex].schedule = e.target.result;
                    saveBuildings();
                    renderGroups(building);
                    alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteGroup(groupIndex) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.groups.splice(groupIndex, 1);
            saveBuildings();
            renderGroups(building);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function switchUserTab(tabName) {
            document.querySelectorAll('#buildingSheet .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#buildingSheet .tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('user' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
        }

        function showBuildingSheet(building) {
            document.getElementById('sheetBuildingName').textContent = building.name;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —ç—Ç–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userFloorsList = document.getElementById('userFloorsList');
            userFloorsList.innerHTML = '';
            
            building.floors.forEach(floor => {
                const floorItem = document.createElement('div');
                floorItem.className = 'floor-item';
                floorItem.innerHTML = `
                    <strong>${floor.name}</strong>
                    ${floor.plan ? `
                        <div class="building-image">
                            <img src="${floor.plan}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" onclick="toggleImageZoom(this)">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; font-size: 12px;">
                                üîç –ù–∞–∂–º–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                            </div>
                        </div>
                    ` : '<p style="color: #bdc3c7; margin: 10px 0;">–ü–ª–∞–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>'}
                `;
                userFloorsList.appendChild(floorItem);
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userGroupsList = document.getElementById('userGroupsList');
            userGroupsList.innerHTML = '';
            
            building.groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <strong>${group.name}</strong>
                    ${group.schedule ? `
                        <div class="building-image">
                            <img src="${group.schedule}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" onclick="toggleImageZoom(this)">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; font-size: 12px;">
                                üîç –ù–∞–∂–º–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                            </div>
                        </div>
                    ` : '<p style="color: #bdc3c7; margin: 10px 0;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>'}
                `;
                userGroupsList.appendChild(groupItem);
            });
            
            document.getElementById('buildingSheet').classList.add('active');
        }

        function toggleImageZoom(img) {
            if (img.style.transform === 'scale(1.5)') {
                img.style.transform = 'scale(1)';
                img.style.cursor = 'zoom-in';
            } else {
                img.style.transform = 'scale(1.5)';
                img.style.cursor = 'zoom-out';
            }
        }

        function closeBuildingSheet() {
            document.getElementById('buildingSheet').classList.remove('active');
        }

        function showAdminPanel() {
            document.getElementById('adminPanel').classList.add('active');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
            const url = new URL(window.location);
            url.searchParams.delete('admin');
            window.history.replaceState({}, '', url);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–¥–∞–Ω–∏—è —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –º–µ—Ç–∫–∏
            loadBuildings();
        }

        ymaps.ready(initMap);
    </script>
</body>
</html>