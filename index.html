<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –†–ñ–î–ö –£—Å—Å—É—Ä–∏–π—Å–∫</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=be0c8369-7476-47a3-a315-59ab429fadcb&lang=ru_RU"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .building-sheet {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transition: bottom 0.4s ease;
            z-index: 999;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
        }

        .building-sheet.active {
            bottom: 0;
        }

        .sheet-handle {
            width: 50px;
            height: 4px;
            background: #7f8c8d;
            border-radius: 2px;
            margin: 0 auto 20px auto;
        }

        .buildings-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 998;
        }

        .building-btn {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.98);
            z-index: 1003;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-content {
            background: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px auto;
        }

        .admin-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .pin-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: #34495e;
            color: white;
        }

        .file-select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: #34495e;
            color: white;
        }

        @media (max-width: 768px) {
            .buildings-bar {
                bottom: 10px;
                flex-wrap: nowrap;
                overflow-x: auto;
                max-width: 90%;
                padding: 0 10px;
            }
            
            .building-btn {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .admin-content {
                margin: 10px auto;
                padding: 15px;
            }
        }

        .building-image {
            width: 100%;
            height: 200px;
            background: #34495e;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bdc3c7;
            border: 2px dashed #7f8c8d;
            position: relative;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: #34495e;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .tab.active {
            background: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .group-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .group-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .floor-item {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .coords-display {
            background: #34495e;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
        }

        .file-info {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 14px;
        }

        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #2c3e50;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–æ–º</h2>
            
            <div class="admin-section">
                <h3>üè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è–º–∏</h3>
                <select id="buildingSelect" class="pin-input" onchange="loadBuildingData()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</option>
                </select>
                
                <input type="text" id="buildingName" class="pin-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è">
                
                <div class="coords-display" id="coordsDisplay">
                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                </div>
                <button class="btn" onclick="startPlacemarkMode()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</button>
                
                <button class="btn" onclick="saveBuilding()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
                <button class="btn btn-success" onclick="addNewBuilding()">‚ûï –ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ</button>
                <button class="btn btn-danger" onclick="deleteBuilding()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
            </div>

            <div class="admin-section" id="buildingDetails" style="display: none;">
                <h3>üìã –î–µ—Ç–∞–ª–∏ –∑–¥–∞–Ω–∏—è: <span id="currentBuildingName">‚Äî</span></h3>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('floors')">–≠—Ç–∞–∂–∏</button>
                    <button class="tab" onclick="switchTab('groups')">–ì—Ä—É–ø–ø—ã</button>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –≠—Ç–∞–∂–∏ -->
                <div class="tab-content active" id="floorsTab">
                    <div id="floorsList">
                        <!-- –°–ø–∏—Å–æ–∫ —ç—Ç–∞–∂–µ–π -->
                    </div>
                    <button class="btn btn-success" onclick="addFloor()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–∂</button>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –ì—Ä—É–ø–ø—ã -->
                <div class="tab-content" id="groupsTab">
                    <input type="text" id="newGroupName" class="pin-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                    <button class="btn btn-success" onclick="addGroup()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                    
                    <div id="groupsList">
                        <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø -->
                    </div>
                </div>
            </div>

            <button class="btn btn-danger" onclick="hideAdminPanel()">‚ùå –ó–∞–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É</button>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∑–¥–∞–Ω–∏–π -->
    <div class="buildings-bar" id="buildingsBar">
        <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>

    <!-- –®—Ç–æ—Ä–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–¥–∞–Ω–∏–∏ -->
    <div class="building-sheet" id="buildingSheet">
        <div class="sheet-handle"></div>
        <h3 id="sheetBuildingName">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è</h3>
        
        <div class="tabs">
            <button class="tab active" onclick="switchUserTab('floors')">üè¢ –≠—Ç–∞–∂–∏</button>
            <button class="tab" onclick="switchUserTab('schedule')">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –≠—Ç–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="tab-content active" id="userFloorsTab">
            <div id="userFloorsList">
                <!-- –≠—Ç–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="tab-content" id="userScheduleTab">
            <div id="userGroupsList">
                <!-- –ì—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            </div>
        </div>
        
        <button class="btn" onclick="closeBuildingSheet()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const ADMIN_SECRET = "secret";
        // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ GitHub
        const CDN_BASE_URL = "https://ujujkm337.github.io/RZDK_MAP0.0.2/files";
        // URL –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª –≤ –≤–∞—à–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
        const DATA_FILE_URL = "https://ujujkm337.github.io/RZDK_MAP0.0.2/data.json";
        
        let map;
        let buildings = [];
        let currentBuildingId = null;
        let isAdminMode = false;
        let placemarkMode = false;
        let tempPlacemark = null;

        // –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ GitHub
        const availableFiles = {
            floorPlans: [
                "1floor.jpg",
                "2floor.jpg", 
                "3floor.jpg",
                "main_building.jpg"
            ],
            schedules: [
                "group1_schedule.jpg",
                "group2_schedule.jpg",
                "music_schedule.jpg",
                "dance_schedule.jpg"
            ]
        };

        const defaultBuildings = [
            {
                id: 1,
                name: '–ì–ª–∞–≤–Ω—ã–π –∫–æ—Ä–ø—É—Å',
                coords: [43.790882, 131.944252],
                floors: [],
                groups: []
            }
        ];

        // –ü—Ä–æ—Å—Ç–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ GitHub - —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
        async function loadBuildingsFromGitHub() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
                const response = await fetch(DATA_FILE_URL + '?t=' + Date.now());
                
                if (response.ok) {
                    const data = await response.json();
                    buildings = data.buildings || defaultBuildings;
                    updateSyncStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                    return true;
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å GitHub:', error);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                const saved = localStorage.getItem('rzhdk_buildings');
                buildings = saved ? JSON.parse(saved) : defaultBuildings;
                updateSyncStatus('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'warning');
                return false;
            }
        }

        function updateSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            
            if (type === 'success') {
                statusEl.style.background = '#27ae60';
            } else if (type === 'error') {
                statusEl.style.background = '#e74c3c';
            } else if (type === 'warning') {
                statusEl.style.background = '#f39c12';
            }
            
            setTimeout(() => {
                statusEl.style.background = '#2c3e50';
                statusEl.textContent = '‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
            }, 3000);
        }

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminParam = urlParams.get('admin');
            
            if (adminParam === ADMIN_SECRET) {
                isAdminMode = true;
                showAdminPanel();
            }
        }

        async function initMap() {
            map = new ymaps.Map('map', {
                center: [43.790882, 131.944252],
                zoom: 17,
                controls: ['zoomControl', 'fullscreenControl']
            });

            await loadBuildings();
            checkAdminAccess();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadBuildings, 30000);
        }

        async function loadBuildings() {
            await loadBuildingsFromGitHub();
            renderBuildings();
            renderBuildingButtons();
            updateBuildingSelect();
        }

        function saveBuildings() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem('rzhdk_buildings', JSON.stringify(buildings));
            updateSyncStatus('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ GitHub
            if (isAdminMode) {
                showGitHubInstructions();
            }
        }

        function showGitHubInstructions() {
            const dataStr = JSON.stringify({ buildings: buildings }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const instruction = `
üìã **–ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ê–î–ú–ò–ù–ê:**

1. üì• **–°–∫–∞—á–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   <a href="${url}" download="data.json" style="color: #3498db;">–°–∫–∞—á–∞—Ç—å data.json</a>

2. üìÅ **–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub
   - –ù–∞–∂–º–∏—Ç–µ "Add file" ‚Üí "Upload files"
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª data.json
   - –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–æ–º–º–∏—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö")
   - –ù–∞–∂–º–∏—Ç–µ "Commit changes"

3. üîÑ **–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥**

üí° *–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitHub Desktop –∏–ª–∏ Git –∫–æ–º–∞–Ω–¥—ã*
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            if (!localStorage.getItem('instruction_shown')) {
                setTimeout(() => {
                    alert(instruction);
                    localStorage.setItem('instruction_shown', 'true');
                }, 1000);
            }
        }

        function renderBuildings() {
            map.geoObjects.removeAll();
            
            if (isAdminMode) return;
            
            buildings.forEach(building => {
                const placemark = new ymaps.Placemark(building.coords, {
                    balloonContent: `<strong>${building.name}</strong>`
                }, {
                    preset: 'islands#blueIcon'
                });
                
                placemark.events.add('click', () => {
                    showBuildingSheet(building);
                });
                
                map.geoObjects.add(placemark);
            });
        }

        function renderBuildingButtons() {
            const bar = document.getElementById('buildingsBar');
            bar.innerHTML = '';
            
            buildings.forEach(building => {
                const btn = document.createElement('button');
                btn.className = 'building-btn';
                btn.textContent = building.name;
                btn.onclick = () => {
                    map.setCenter(building.coords, 17);
                    showBuildingSheet(building);
                };
                bar.appendChild(btn);
            });
        }

        function updateBuildingSelect() {
            const select = document.getElementById('buildingSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</option>';
            
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                select.appendChild(option);
            });
        }

        function loadBuildingData() {
            const buildingId = parseInt(document.getElementById('buildingSelect').value);
            currentBuildingId = buildingId;
            
            if (!buildingId) {
                clearBuildingForm();
                return;
            }
            
            const building = buildings.find(b => b.id === buildingId);
            if (building) {
                document.getElementById('buildingName').value = building.name;
                document.getElementById('currentBuildingName').textContent = building.name;
                document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${building.coords[0]}, ${building.coords[1]}`;
                document.getElementById('buildingDetails').style.display = 'block';
                
                renderFloors(building);
                renderGroups(building);
            }
        }

        function clearBuildingForm() {
            document.getElementById('buildingName').value = '';
            document.getElementById('currentBuildingName').textContent = '‚Äî';
            document.getElementById('coordsDisplay').textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã';
            document.getElementById('buildingDetails').style.display = 'none';
            currentBuildingId = null;
        }

        function startPlacemarkMode() {
            if (!currentBuildingId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–¥–∞–Ω–∏–µ');
                return;
            }
            
            placemarkMode = true;
            
            if (tempPlacemark) {
                map.geoObjects.remove(tempPlacemark);
            }
            
            tempPlacemark = new ymaps.Placemark(map.getCenter(), {}, {
                preset: 'islands#redIcon',
                draggable: true
            });
            
            map.geoObjects.add(tempPlacemark);
            
            tempPlacemark.events.add('dragend', function() {
                const coords = tempPlacemark.geometry.getCoordinates();
                document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            });
            
            alert('üìç –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –º–µ—Ç–∫—É –Ω–∞ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–¥–∞–Ω–∏–µ');
        }

        function addNewBuilding() {
            const newId = buildings.length > 0 ? Math.max(...buildings.map(b => b.id)) + 1 : 1;
            currentBuildingId = newId;
            
            const newBuilding = {
                id: newId,
                name: '–ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ',
                coords: map.getCenter(),
                floors: [],
                groups: []
            };
            buildings.push(newBuilding);
            
            document.getElementById('buildingName').value = newBuilding.name;
            document.getElementById('currentBuildingName').textContent = newBuilding.name;
            document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${newBuilding.coords[0].toFixed(6)}, ${newBuilding.coords[1].toFixed(6)}`;
            document.getElementById('buildingDetails').style.display = 'block';
            
            updateBuildingSelect();
            document.getElementById('buildingSelect').value = newId;
            
            saveBuildings();
            renderBuildingButtons();
            
            alert('‚úÖ –ù–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! –¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–µ—Ç–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.');
        }

        function saveBuilding() {
            if (!currentBuildingId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–¥–∞–Ω–∏–µ');
                return;
            }
            
            let building = buildings.find(b => b.id === currentBuildingId);
            let coords;
            
            if (tempPlacemark) {
                coords = tempPlacemark.geometry.getCoordinates();
                map.geoObjects.remove(tempPlacemark);
                tempPlacemark = null;
            } else if (building) {
                coords = building.coords;
            } else {
                coords = map.getCenter();
            }
            
            if (building) {
                building.name = document.getElementById('buildingName').value;
                building.coords = coords;
            }
            
            document.getElementById('coordsDisplay').textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            
            saveBuildings();
            
            alert('‚úÖ –ó–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ GitHub.');
            placemarkMode = false;
        }

        function deleteBuilding() {
            if (!currentBuildingId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ "${document.getElementById('buildingName').value}"?`)) {
                return;
            }
            
            buildings = buildings.filter(b => b.id !== currentBuildingId);
            saveBuildings();
            updateBuildingSelect();
            clearBuildingForm();
            
            alert('‚úÖ –ó–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ GitHub.');
        }

        function addFloor() {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            const floorNumber = building.floors.length + 1;
            
            building.floors.push({
                number: floorNumber,
                name: `–≠—Ç–∞–∂ ${floorNumber}`,
                planFile: null
            });
            
            saveBuildings();
            renderFloors(building);
        }

        function renderFloors(building) {
            const floorsList = document.getElementById('floorsList');
            floorsList.innerHTML = '';
            
            building.floors.forEach((floor, index) => {
                const floorItem = document.createElement('div');
                floorItem.className = 'floor-item';
                
                const selectOptions = availableFiles.floorPlans.map(file => 
                    `<option value="${file}" ${floor.planFile === file ? 'selected' : ''}>${file}</option>`
                ).join('');
                
                floorItem.innerHTML = `
                    <strong>${floor.name}</strong>
                    <div style="margin-top: 10px;">
                        <input type="text" value="${floor.name}" onchange="updateFloorName(${index}, this.value)" class="pin-input" style="font-size: 12px; padding: 8px;">
                        <select class="file-select" onchange="updateFloorPlan(${index}, this.value)">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω —ç—Ç–∞–∂–∞ --</option>
                            ${selectOptions}
                        </select>
                        ${floor.planFile ? `
                            <div class="file-info">
                                ‚úÖ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${floor.planFile}
                            </div>
                        ` : ''}
                        <button class="btn" style="background: #e74c3c; padding: 8px; margin-top: 5px;" onclick="deleteFloor(${index})">‚ùå –£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–∂</button>
                    </div>
                `;
                floorsList.appendChild(floorItem);
            });
        }

        function updateFloorName(floorIndex, newName) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.floors[floorIndex].name = newName;
            saveBuildings();
        }

        function updateFloorPlan(floorIndex, fileName) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.floors[floorIndex].planFile = fileName || null;
            saveBuildings();
            renderFloors(building);
            
            if (fileName) {
                alert('‚úÖ –ü–ª–∞–Ω —ç—Ç–∞–∂–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
            }
        }

        function deleteFloor(floorIndex) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.floors.splice(floorIndex, 1);
            saveBuildings();
            renderFloors(building);
        }

        function addGroup() {
            if (!currentBuildingId) return;
            
            const groupName = document.getElementById('newGroupName').value.trim();
            if (!groupName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            const building = buildings.find(b => b.id === currentBuildingId);
            
            building.groups.push({
                name: groupName,
                scheduleFile: null
            });
            
            document.getElementById('newGroupName').value = '';
            saveBuildings();
            renderGroups(building);
        }

        function renderGroups(building) {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';
            
            building.groups.forEach((group, index) => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                
                const selectOptions = availableFiles.schedules.map(file => 
                    `<option value="${file}" ${group.scheduleFile === file ? 'selected' : ''}>${file}</option>`
                ).join('');
                
                groupItem.innerHTML = `
                    <div class="group-header">
                        <strong>${group.name}</strong>
                        <button class="btn" style="background: #e74c3c; padding: 5px 10px;" onclick="deleteGroup(${index})">‚ùå</button>
                    </div>
                    <select class="file-select" onchange="updateGroupSchedule(${index}, this.value)">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ --</option>
                        ${selectOptions}
                    </select>
                    ${group.scheduleFile ? `
                        <div class="file-info">
                            ‚úÖ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${group.scheduleFile}
                        </div>
                    ` : ''}
                `;
                groupsList.appendChild(groupItem);
            });
        }

        function updateGroupSchedule(groupIndex, fileName) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.groups[groupIndex].scheduleFile = fileName || null;
            saveBuildings();
            renderGroups(building);
            
            if (fileName) {
                alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            }
        }

        function deleteGroup(groupIndex) {
            if (!currentBuildingId) return;
            
            const building = buildings.find(b => b.id === currentBuildingId);
            building.groups.splice(groupIndex, 1);
            saveBuildings();
            renderGroups(building);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function switchUserTab(tabName) {
            document.querySelectorAll('#buildingSheet .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#buildingSheet .tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('user' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
        }

        function showBuildingSheet(building) {
            document.getElementById('sheetBuildingName').textContent = building.name;
            
            const userFloorsList = document.getElementById('userFloorsList');
            userFloorsList.innerHTML = '';
            
            building.floors.forEach(floor => {
                const floorItem = document.createElement('div');
                floorItem.className = 'floor-item';
                floorItem.innerHTML = `
                    <strong>${floor.name}</strong>
                    ${floor.planFile ? `
                        <div class="building-image">
                            <img src="${CDN_BASE_URL}${floor.planFile}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" onclick="toggleImageZoom(this)" alt="–ü–ª–∞–Ω ${floor.name}">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; font-size: 12px;">
                                üîç –ù–∞–∂–º–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                            </div>
                        </div>
                    ` : '<p style="color: #bdc3c7; margin: 10px 0;">–ü–ª–∞–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>'}
                `;
                userFloorsList.appendChild(floorItem);
            });
            
            const userGroupsList = document.getElementById('userGroupsList');
            userGroupsList.innerHTML = '';
            
            building.groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <strong>${group.name}</strong>
                    ${group.scheduleFile ? `
                        <div class="building-image">
                            <img src="${CDN_BASE_URL}${group.scheduleFile}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" onclick="toggleImageZoom(this)" alt="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ${group.name}">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; font-size: 12px;">
                                üîç –ù–∞–∂–º–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                            </div>
                        </div>
                    ` : '<p style="color: #bdc3c7; margin: 10px 0;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>'}
                `;
                userGroupsList.appendChild(groupItem);
            });
            
            document.getElementById('buildingSheet').classList.add('active');
        }

        function toggleImageZoom(img) {
            if (img.style.transform === 'scale(1.5)') {
                img.style.transform = 'scale(1)';
                img.style.cursor = 'zoom-in';
            } else {
                img.style.transform = 'scale(1.5)';
                img.style.cursor = 'zoom-out';
            }
        }

        function closeBuildingSheet() {
            document.getElementById('buildingSheet').classList.remove('active');
        }

        function showAdminPanel() {
            document.getElementById('adminPanel').classList.add('active');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
            const url = new URL(window.location);
            url.searchParams.delete('admin');
            window.history.replaceState({}, '', url);
            loadBuildings();
        }

        ymaps.ready(initMap);
    </script>
</body>
</html>